{% extends "base.html" %}

{% block title %}錯誤記錄列表{% endblock %}

{% block content %}
    <!-- 已登入：顯示完整列表與功能 -->
    {% if show_list %}
        <div class="row mb-4">
            <div class="col-md-6">
                <form class="d-flex" method="GET">
                    <input type="text" name="query" class="form-control me-2" placeholder="搜尋錯誤細節、系統或備註..." value="{{ query or '' }}">
                    <button class="btn btn-outline-primary" type="submit">搜尋</button>
                </form>
            </div>
            <div class="col-md-6 text-end">
                <a href="{{ url_for('add_bug') }}" class="btn btn-success me-2">新增錯誤記錄</a>
                <a href="{{ url_for('export_excel') }}" class="btn btn-info">匯出 Excel 報表</a>
            </div>
        </div>

        {% if bugs|length == 0 %}
            <div class="alert alert-info text-center">
                {% if query %}
                    沒有找到符合「{{ query }}」的記錄。
                {% else %}
                    目前尚未有任何錯誤記錄。
                {% endif %}
            </div>
        {% else %}
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                    <thead class="table-primary">
                        <tr>
                            <th>ID</th>
                            <th>報告日期</th>
                            <th>系統</th>
                            <th>錯誤細節</th>
                            <th>報告者</th>
                            <th>報告者帳號</th>
                            <th>狀態</th>
                            <th>優先級</th>
                            <th>嚴重程度</th>
                            <th>指派給</th>
                            <th>解決日期</th>
                            <th>備註</th>
                            <th class="text-center">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for bug in bugs %}
                        <tr>
                            <td><strong>{{ bug['id'] }}</strong></td>
                            <td>{{ bug['report_date']|format_datetime }}</td>
                            <td>{{ bug['system'] }}</td>
                            <td>{{ bug['bug_details'] }}</td>
                            <td>{{ bug['reported_by'] }}</td>
                            <td>{{ bug['reporter_username'] or '（未登入使用者）' }}</td>
                            <td>
                                {% if bug['status'] == '開放中' %}<span class="badge bg-warning text-dark">開放中</span>
                                {% elif bug['status'] == '處理中' %}<span class="badge bg-info">處理中</span>
                                {% elif bug['status'] == '已解決' %}<span class="badge bg-success">已解決</span>
                                {% elif bug['status'] == '已關閉' %}<span class="badge bg-secondary">已關閉</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if bug['priority'] == '低' %}<span class="badge bg-light text-dark">低</span>
                                {% elif bug['priority'] == '中' %}<span class="badge bg-primary">中</span>
                                {% elif bug['priority'] == '高' %}<span class="badge bg-danger">高</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if bug['severity'] == '輕微' %}<span class="badge bg-light text-dark">輕微</span>
                                {% elif bug['severity'] == '中' %}<span class="badge bg-primary">中</span>
                                {% elif bug['severity'] == '重大' %}<span class="badge bg-warning text-dark">重大</span>
                                {% elif bug['severity'] == '嚴重' %}<span class="badge bg-danger">嚴重</span>
                                {% endif %}
                            </td>
                            <td>{{ bug['assigned_to'] or '-' }}</td>
                            <td>{{ bug['resolution_date']|format_datetime or '-' }}</td>
                            <td>{{ bug['notes'] or '-' }}</td>
                            <td class="text-center">
                                {% if bug['can_edit'] and bug['status'] not in ['已解決', '已關閉'] %}
                                    <a href="{{ url_for('edit_bug', id=bug['id']) }}" class="btn btn-warning btn-sm">編輯</a>
                                {% elif bug['status'] in ['已解決', '已關閉'] %}
                                    <span class="badge bg-dark">已鎖定</span>
                                {% endif %}

                                {% if bug['can_edit'] %}
                                    <form action="{{ url_for('delete_bug', id=bug['id']) }}" method="POST" style="display:inline;" onsubmit="return confirm('確定要刪除這筆記錄嗎？');">
                                        <button type="submit" class="btn btn-danger btn-sm">刪除</button>
                                    </form>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="text-muted small mt-3">
                共 {{ bugs|length }} 筆記錄
                {% if query %}（搜尋條件：「{{ query }}」）{% endif %}
            </div>
        {% endif %}

    <!-- 未登入：顯示歡迎畫面 -->
    {% else %}
        <div class="text-center mt-5 py-5">
            <h2 class="mb-4">歡迎使用程式錯誤追蹤系統</h2>
            <p class="lead text-muted mb-5">
                請先登入才能查看所有錯誤記錄與完整功能<br>
                未登入也可直接回報新錯誤
            </p>
            <div class="d-grid gap-3 col-md-4 mx-auto">
                <a href="{{ url_for('add_bug') }}" class="btn btn-success btn-lg">直接新增錯誤記錄</a>
                <a href="{{ url_for('login') }}" class="btn btn-primary btn-lg">登入查看記錄</a>
            </div>
            <p class="mt-5 text-muted">
                還沒有帳號？ <a href="{{ url_for('register') }}">立即註冊</a>
            </p>
        </div>
    {% endif %}
{% endblock %}